<!doctype html>
<html>
<head>
    <base>
    <meta http-equiv="Content-type=text/html;charset=utf-8"/>
    <title>聊天室</title>
    <link rel="stylesheet" href="/stylesheets/bootstrap-theme.css"/>
    <link rel="stylesheet" href="/stylesheets/bootstrap.css"/>
    <script language="javascript" src="/javascript/jquery.js"></script>
    <script language="javascript" src="/javascript/bootstrap.js"></script>
    <script language="javascript" src="/socket.io/socket.io.js"></script>
    <script language="javascript">
        var socket = io.connect("127.0.0.1:1337");
        var html = "";

        function createhtml(message) {
            html += '<div class="list-group-item message"> '+message.user+' : ' + message.content;
            html += '</div>';
            $(".messages").html(html);
        }

        function createhtml2(messages) {
               for(var i in messages){
                  html += '<div class="list-group-item message"> '+messages[i].user+' : ' + messages[i].content;
                  html += '</div>';
                  $(".messages").html(html);
               }
        }
        var ctrlDown = false;
        var messages ;
        $(document).ready(function () {
            $(".message-input").bind("keydown", function (event) {
                if (event.keyCode === 17) {
                    ctrlDown = true;
                    setTimeout(function (event) {
                        ctrlDown = false
                    }, 1000);
                }
                var username = "<% if (user){%><%= user.username%><%}else{ %> <% } %>";
                if (event.keyCode === 13) {
                    if (ctrlDown) {
                        $(".message-input").val("");
                    } else {
                        var value = $(".message-input").val();
                        $(".message-input").val('');
                        var message = {
                            content:value,
                            user: username,
                            time : new Date().getTime()
                        };
                        if (value) {
                            socket.emit("createMessage", message);
                            value = "";
                            socket.on('error',function (data){
                                console.log(data);
                            });
                        }
                    }
                }
            });

            socket.on("messageAdded", function (message) {
                createhtml(message);
            });

            socket.emit('getAllMessages');
            socket.on('allMessages',function (messages){
                createhtml2(messages);
            })
        });
    </script>
</head>
<body >

<nav class="collapse navbar-collapse" role="navigation">
    <!--<li>-->
        <!--<img src="{{me.avatarUrl}}" title="{{me.name}}" class="img-rounded">-->
    <!--</li>-->
    <!--<li href="" ng-click="logout()"><a style="font-color:white">Log Out</a></li>-->
</nav>
<div class="nav navbar-inverse navbar-fixed-top">
    <div class="container">
        <div class="navar header">
            <a class="navbar-brand">TechNode</a>
            <ul class="nav navbar-nav navbar-right hidden-sm">

               <li>
                <% if (user){ %>
                    <a class="navbar-brand"><span>欢迎回来</span> <span><%= user.username%></span></a>
                     <a class="navbar-brand" href="/logout">退出</a>
                <%}else{%>
                       <a class="navbar-brand">登录</a>
                       <a class="navbar-brand">注册</a>
                <% } %>
               </li>
            </ul>
        </div>

    </div>
</div>
<div class="container" style="margin-top:100px">
    <div class="col-md-12">
        <div class="pannel pannle-defaut room">
            <div class="pannel-heading room-header">TechNode</div>
            <div class="pannel body room-content">
                <div class="list-group messages">
                    <div class="list-group-item message">
                    </div>
                </div>
            </div>
            <form class="message-creator" ng-controller="MessageCreatorCtrl">
                <div class="form-group">
                    <textarea required class="form-control message-input" placeorder="Ctrl Enter to quick send">
                    </textarea>
                </div>
            </form>
        </div>
    </div>
</div>
</body>
</html>